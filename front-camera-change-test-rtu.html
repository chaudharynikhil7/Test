<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamsoft Barcode Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@11.2.2000/dist/dbr.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda@3.0.1/eruda.min.js"></script>
    <script>
      eruda.init();
    </script>
  </head>

  <body>
    <script>
      // Global flag to track onCameraOpen callback
      let onCameraOpenCalled = false;

      const barcodeScannerConfig = {
        // license: "LICENSE-KEY",
        license:
          "DLS2eyJoYW5kc2hha2VDb2RlIjoiMTAwMTg0NTA5LVRYbFhaV0pRY205cSIsIm1haW5TZXJ2ZXJVUkwiOiJodHRwczovL21kbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJvcmdhbml6YXRpb25JRCI6IjEwMDE4NDUwOSIsInN0YW5kYnlTZXJ2ZXJVUkwiOiJodHRwczovL3NkbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJjaGVja0NvZGUiOjEzNDQxNjc1MDB9",

        scanMode: Dynamsoft.EnumScanMode.SM_MULTI_UNIQUE,
        showResultView: true,
        // iPhone-specific: Add error handling for camera issues
        onCameraSetupError: (error) => {
          console.error("Camera setup error:", error);
          // Try to recover by refreshing the page on iPhone
          if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            console.log("iPhone detected, attempting recovery...");
            setTimeout(() => {
              location.reload();
            }, 3000);
          }
        },
        onInitReady: async (components) => {
          console.log("OnInitReady - Camera state:", components.cameraEnhancer.getCameraState());

          try {
            // Test camera access first
            const testResponse = await Dynamsoft.DCE.CameraEnhancer.testCameraAccess();
            console.log("Camera access test:", testResponse);

            const cameras = await components.cameraEnhancer.getAllCameras();
            console.log("Total cameras found:", cameras.length);
            console.log(
              "All cameras:",
              cameras.map((c) => ({ label: c.label, deviceId: c.deviceId }))
            );

            if (cameras.length > 1) {
              console.log("Attempting to select camera:", cameras[3].label);

              // For iPhone: Close camera first if it's open, then select
              if (components.cameraEnhancer.isOpen()) {
                console.log("Closing camera before selection...");
                await components.cameraEnhancer.close();
              }

              // Select the camera
              const selectResult = await components.cameraEnhancer.selectCamera(cameras[3]);
              console.log("Camera selection result:", selectResult);

              // iPhone-specific: Add delay and check video stream
              await new Promise((resolve) => setTimeout(resolve, 1000));
              console.log("After selection delay - Camera state:", components.cameraEnhancer.getCameraState());
              console.log("After selection delay - Is open:", components.cameraEnhancer.isOpen());

              // Check video element immediately after selection
              const videoEl = components.cameraEnhancer.getVideoEl();
              console.log("Video element after selection:", videoEl);
              console.log("Video srcObject after selection:", videoEl ? videoEl.srcObject : "No video");
              console.log("Video readyState after selection:", videoEl ? videoEl.readyState : "No video");

              // For iPhone: Explicitly open the camera after selection
              if (!components.cameraEnhancer.isOpen()) {
                console.log("Opening camera after selection...");
                const openResult = await components.cameraEnhancer.open();
                console.log("Camera open result:", openResult);
              }

              console.log("Selected camera:", cameras[3].label);
              console.log("Final camera state:", components.cameraEnhancer.getCameraState());

              // iPhone-specific: Force video stream refresh if needed
              if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                console.log("iPhone detected - checking video stream...");
                const videoElFinal = components.cameraEnhancer.getVideoEl();
                if (!videoElFinal || !videoElFinal.srcObject) {
                  console.log("Video stream missing on iPhone - attempting recovery...");
                  try {
                    await components.cameraEnhancer.close();
                    await new Promise((resolve) => setTimeout(resolve, 500));
                    await components.cameraEnhancer.open();
                    console.log("iPhone video stream recovery attempted");
                  } catch (recoveryError) {
                    console.error("iPhone recovery failed:", recoveryError);
                  }
                } else {
                  console.log("Video stream exists - manually triggering UI update...");

                  // Force the UI to recognize the camera is working
                  try {
                    // Get the camera view and force it to update
                    const cameraView = components.cameraEnhancer.getCameraView();
                    if (cameraView) {
                      console.log("Camera view found, forcing refresh...");
                      // Try to force a view refresh by toggling the video
                      const video = components.cameraEnhancer.getVideoEl();
                      if (video && video.srcObject) {
                        console.log("Forcing video element refresh...");
                        video.load(); // Force reload of video element

                        // Ensure video plays
                        if (video.paused) {
                          await video.play();
                          console.log("Video forced to play");
                        }

                        // Force a paint/render update
                        video.style.display = "none";
                        video.offsetHeight; // Force reflow
                        video.style.display = "";
                        console.log("Forced UI refresh completed");
                      }
                    }

                    // Alternative: Try to manually call the onCameraOpen callback
                    console.log("Manually triggering onCameraOpen logic...");
                    const currentCamera = components.cameraEnhancer.getSelectedCamera();
                    console.log("Manual check - Camera:", currentCamera?.label);
                    console.log("Manual check - Camera state:", components.cameraEnhancer.getCameraState());
                    console.log("Manual check - Is open:", components.cameraEnhancer.isOpen());

                    // Last resort: Close and reopen to trigger proper callbacks
                    if (components.cameraEnhancer.isOpen()) {
                      console.log("Attempting full camera restart to trigger callbacks...");

                      // Check MediaStream status before restart
                      const videoBefore = components.cameraEnhancer.getVideoEl();
                      const streamBefore = videoBefore?.srcObject;
                      console.log("Before restart - Stream active:", streamBefore?.active);
                      console.log("Before restart - Stream tracks:", streamBefore?.getTracks?.()?.length);

                      await components.cameraEnhancer.close();
                      console.log("Camera closed, state:", components.cameraEnhancer.getCameraState());

                      await new Promise((resolve) => setTimeout(resolve, 1000));
                      console.log("About to reopen camera...");

                      const reopenResult = await components.cameraEnhancer.open();
                      console.log("Camera reopen result:", reopenResult);
                      console.log("After restart - Camera state:", components.cameraEnhancer.getCameraState());
                      console.log("After restart - Is open:", components.cameraEnhancer.isOpen());

                      // Check MediaStream status after restart
                      const videoAfter = components.cameraEnhancer.getVideoEl();
                      const streamAfter = videoAfter?.srcObject;
                      console.log("After restart - Video element:", !!videoAfter);
                      console.log("After restart - Stream active:", streamAfter?.active);
                      console.log("After restart - Stream tracks:", streamAfter?.getTracks?.()?.length);
                      console.log("After restart - Video readyState:", videoAfter?.readyState);

                      console.log("Full camera restart completed");

                      // Give some time for callbacks to fire
                      await new Promise((resolve) => setTimeout(resolve, 2000));
                      console.log("Waiting period completed - checking if onCameraOpen was called...");
                      console.log("OnCameraOpen callback called:", onCameraOpenCalled);

                      if (!onCameraOpenCalled) {
                        console.log("ERROR: OnCameraOpen was never called! This is the root issue.");
                        console.log("The camera is technically working but the UI isn't updating.");
                        console.log("Manual workaround needed - check if video stream is actually active");

                        // Instead of reloading, let's try a different approach
                        const finalVideo = components.cameraEnhancer.getVideoEl();
                        const finalStream = finalVideo?.srcObject;

                        if (finalStream && finalStream.active) {
                          console.log("Stream is active - this might be a UI display issue only");
                        } else {
                          console.log("Stream is inactive - this is a deeper MediaStream issue");
                        }

                        console.log("Recommendation: Manually refresh the page to try again");
                      } else {
                        console.log("SUCCESS: OnCameraOpen was called!");
                      }
                    }
                  } catch (uiError) {
                    console.error("UI refresh failed:", uiError);
                  }
                }
              }
            }
          } catch (error) {
            console.error("Error in camera setup:", error);
          }
        },
        onCameraOpen: async (components) => {
          onCameraOpenCalled = true;
          console.log("=== OnCameraOpen Callback === (FLAG SET TO TRUE)");
          console.log("Camera opened - state:", components.cameraEnhancer.getCameraState());
          console.log("Is camera open?", components.cameraEnhancer.isOpen());
          console.log("Is camera paused?", components.cameraEnhancer.isPaused());

          let currentCamera = components.cameraEnhancer.getSelectedCamera();
          console.log("Camera after opening:", currentCamera ? currentCamera.label : "No camera");

          // Check video element
          const videoEl = components.cameraEnhancer.getVideoEl();
          console.log("Video element:", videoEl);
          console.log("Video srcObject:", videoEl ? videoEl.srcObject : "No video element");
          console.log("Video readyState:", videoEl ? videoEl.readyState : "No video element");
          console.log("Video dimensions:", videoEl ? `${videoEl.videoWidth}x${videoEl.videoHeight}` : "No video");

          // Get camera capabilities for debugging
          try {
            const capabilities = components.cameraEnhancer.getCapabilities();
            console.log("Camera capabilities:", capabilities);
          } catch (error) {
            console.log("Could not get capabilities:", error);
          }

          // iPhone-specific: Check if we need to resume the camera
          if (components.cameraEnhancer.isPaused()) {
            console.log("Camera is paused, attempting to resume...");
            try {
              await components.cameraEnhancer.resume();
              console.log("Camera resumed successfully");
            } catch (error) {
              console.error("Error resuming camera:", error);
            }
          }

          // iPhone-specific: Additional video stream validation
          if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            console.log("iPhone onCameraOpen - performing additional checks...");

            // Check if video is actually playing
            if (videoEl) {
              console.log("Video paused?", videoEl.paused);
              console.log("Video muted?", videoEl.muted);
              console.log("Video autoplay?", videoEl.autoplay);

              // Try to ensure video is playing
              if (videoEl.paused) {
                try {
                  await videoEl.play();
                  console.log("Video play() called successfully");
                } catch (playError) {
                  console.error("Video play() failed:", playError);
                }
              }
            }
          }
        },
      };

      const barcodeScanner = new Dynamsoft.BarcodeScanner(barcodeScannerConfig);

      (async () => {
        try {
          console.log("Launching barcode scanner...");
          console.log("User agent:", navigator.userAgent);
          console.log("Is iPhone?", /iPhone|iPad|iPod/i.test(navigator.userAgent));

          const result = await barcodeScanner.launch();
          console.log("Scanner launched successfully:", result);
        } catch (error) {
          console.error("Error launching scanner:", error);

          // iPhone-specific error recovery
          if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            console.log("iPhone error detected, trying alternative approach...");

            // Try to launch again after a delay
            setTimeout(async () => {
              try {
                console.log("Retrying scanner launch...");
                const retryResult = await barcodeScanner.launch();
                console.log("Retry successful:", retryResult);
              } catch (retryError) {
                console.error("Retry failed:", retryError);
                alert("Camera access failed on iPhone. Please refresh the page and allow camera permissions.");
              }
            }, 2000);
          }
        }
      })();
    </script>
  </body>
</html>
