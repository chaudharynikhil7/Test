<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamsoft Barcode Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@11.2.2000/dist/dbr.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda@3.0.1/eruda.min.js"></script>
    <script>
      eruda.init();
    </script>
  </head>

  <body>
    <script>
      // Global flag to track onCameraOpen callback
      let onCameraOpenCalled = false;

      const barcodeScannerConfig = {
        // license: "LICENSE-KEY",
        license:
          "DLS2eyJoYW5kc2hha2VDb2RlIjoiMTAwMTg0NTA5LVRYbFhaV0pRY205cSIsIm1haW5TZXJ2ZXJVUkwiOiJodHRwczovL21kbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJvcmdhbml6YXRpb25JRCI6IjEwMDE4NDUwOSIsInN0YW5kYnlTZXJ2ZXJVUkwiOiJodHRwczovL3NkbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJjaGVja0NvZGUiOjEzNDQxNjc1MDB9",

        scanMode: Dynamsoft.EnumScanMode.SM_MULTI_UNIQUE,
        showResultView: true,
        // Configure camera constraints to prefer back camera from the start
        cameraEnhancerConfig: {
          videoConstraints: {
            facingMode: { ideal: "environment" }, // This will prefer back camera
            width: { ideal: 1280 },
            height: { ideal: 720 },
          },
        },
        // iPhone-specific: Add error handling for camera issues
        onCameraSetupError: (error) => {
          console.error("Camera setup error:", error);
          // Try to recover by refreshing the page on iPhone
          if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            console.log("iPhone detected, attempting recovery...");
            setTimeout(() => {
              location.reload();
            }, 3000);
          }
        },
        onInitReady: async (components) => {
          console.log("OnInitReady - Camera state:", components.cameraEnhancer.getCameraState());

          try {
            // Test camera access first
            const testResponse = await Dynamsoft.DCE.CameraEnhancer.testCameraAccess();
            console.log("Camera access test:", testResponse);

            const cameras = await components.cameraEnhancer.getAllCameras();
            console.log("Total cameras found:", cameras.length);
            console.log(
              "All cameras:",
              cameras.map((c) => ({ label: c.label, deviceId: c.deviceId }))
            );

            // Let the scanner choose the camera naturally based on videoConstraints
            console.log("Letting scanner auto-select camera based on facingMode constraint...");

            // Just wait a moment and check what camera was selected
            setTimeout(() => {
              const selectedCamera = components.cameraEnhancer.getSelectedCamera();
              console.log("Auto-selected camera:", selectedCamera?.label);
              console.log("Auto-selected camera state:", components.cameraEnhancer.getCameraState());
            }, 2000);
          } catch (error) {
            console.error("Error in camera setup:", error);
          }
        },
        onCameraOpen: async (components) => {
          onCameraOpenCalled = true;
          console.log("=== OnCameraOpen Callback === (FLAG SET TO TRUE)");
          console.log("Camera opened - state:", components.cameraEnhancer.getCameraState());
          console.log("Is camera open?", components.cameraEnhancer.isOpen());
          console.log("Is camera paused?", components.cameraEnhancer.isPaused());

          let currentCamera = components.cameraEnhancer.getSelectedCamera();
          console.log("Camera after opening:", currentCamera ? currentCamera.label : "No camera");

          // Check video element
          const videoEl = components.cameraEnhancer.getVideoEl();
          console.log("Video element:", videoEl);
          console.log("Video srcObject:", videoEl ? videoEl.srcObject : "No video element");
          console.log("Video readyState:", videoEl ? videoEl.readyState : "No video element");
          console.log("Video dimensions:", videoEl ? `${videoEl.videoWidth}x${videoEl.videoHeight}` : "No video");

          // Get camera capabilities for debugging
          try {
            const capabilities = components.cameraEnhancer.getCapabilities();
            console.log("Camera capabilities:", capabilities);
          } catch (error) {
            console.log("Could not get capabilities:", error);
          }

          // iPhone-specific: Check if we need to resume the camera
          if (components.cameraEnhancer.isPaused()) {
            console.log("Camera is paused, attempting to resume...");
            try {
              await components.cameraEnhancer.resume();
              console.log("Camera resumed successfully");
            } catch (error) {
              console.error("Error resuming camera:", error);
            }
          }

          // iPhone-specific: Additional video stream validation
          if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            console.log("iPhone onCameraOpen - performing additional checks...");

            // Check if video is actually playing
            if (videoEl) {
              console.log("Video paused?", videoEl.paused);
              console.log("Video muted?", videoEl.muted);
              console.log("Video autoplay?", videoEl.autoplay);

              // Try to ensure video is playing
              if (videoEl.paused) {
                try {
                  await videoEl.play();
                  console.log("Video play() called successfully");
                } catch (playError) {
                  console.error("Video play() failed:", playError);
                }
              }
            }
          }
        },
      };

      const barcodeScanner = new Dynamsoft.BarcodeScanner(barcodeScannerConfig);

      (async () => {
        try {
          console.log("Launching barcode scanner...");
          console.log("User agent:", navigator.userAgent);
          console.log("Is iPhone?", /iPhone|iPad|iPod/i.test(navigator.userAgent));

          const result = await barcodeScanner.launch();
          console.log("Scanner launched successfully:", result);
        } catch (error) {
          console.error("Error launching scanner:", error);

          // iPhone-specific error recovery
          if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            console.log("iPhone error detected, trying alternative approach...");

            // Try to launch again after a delay
            setTimeout(async () => {
              try {
                console.log("Retrying scanner launch...");
                const retryResult = await barcodeScanner.launch();
                console.log("Retry successful:", retryResult);
              } catch (retryError) {
                console.error("Retry failed:", retryError);
                alert("Camera access failed on iPhone. Please refresh the page and allow camera permissions.");
              }
            }, 2000);
          }
        }
      })();
    </script>
  </body>
</html>
